name: Sync Priority to Project Board
on:
  issues:
    types: [labeled, unlabeled]
  workflow_dispatch:  # Add this so you can manually trigger it

jobs:
  sync-to-project:
    if: false  # This disables it - remove when ready to test
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write
    steps:
      - name: Sync priority label to project board
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(label => label.name);
            
            // Find the priority label
            const priorityLabels = ['P0: Critical', 'P1: High', 'P2: Medium', 'P3: Low', 'P4: Trivial/Wishlist'];
            const currentPriority = labels.find(label => priorityLabels.includes(label));
            
            if (!currentPriority) {
              console.log('No priority label found');
              return;
            }
            
            console.log(`Found priority: ${currentPriority}`);
            
            // Map label to project field value
            const priorityMap = {
              'P0: Critical': 'P0',
              'P1: High': 'P1',
              'P2: Medium': 'P2',
              'P3: Low': 'P3',
            };
            
            const projectPriority = priorityMap[currentPriority];
            
            // Get the project items for this issue
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                          field(name: "Priority") {
                            ... on ProjectV2SingleSelectField {
                              id
                              options {
                                id
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: issue.number
            });
            
            const projectItems = result.repository.issue.projectItems.nodes;
            
            if (projectItems.length === 0) {
              console.log('Issue not in any project');
              return;
            }
            
            // Update each project item
            for (const item of projectItems) {
              const priorityField = item.project.field;
              
              if (!priorityField) {
                console.log(`Project "${item.project.title}" doesn't have a Priority field`);
                continue;
              }
              
              // Find the option ID for the priority value
              const option = priorityField.options.find(opt => opt.name === projectPriority);
              
              if (!option) {
                console.log(`Priority value "${projectPriority}" not found in project "${item.project.title}"`);
                continue;
              }
              
              console.log(`Updating project "${item.project.title}" to ${projectPriority}`);
              
              // Update the project item
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {
                        singleSelectOptionId: $optionId
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              await github.graphql(mutation, {
                projectId: item.project.id,
                itemId: item.id,
                fieldId: priorityField.id,
                optionId: option.id
              });
              
              console.log('Successfully updated!');
            }
