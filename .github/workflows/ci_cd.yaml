name: ci_cd

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-22.04-4core
    timeout-minutes: 20
    steps:
      - name: Checkout ${{ github.sha }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Fetch more history to be likely to find a successful commit when identifying affected apps
      - name: Use Node.js
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          registry-url: https://registry.npmjs.org/
      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            libraries/*/node_modules
          key: ${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-modules-${{ hashFiles('package-lock.json') }}

      - name: Install NPM dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci --audit false --fund false
        
      - name: Log runner info
        run: echo "CPU cores:" && nproc && echo "Memory:" && free -h | head -2

      - name: Get affected apps
        id: get_affected_apps
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW_NAME: ${{ github.workflow }}
          GH_TOKEN: ${{ github.token }}
        run: |
          TURBO_FILTER=$(npm run turbo_filter --silent --workspace @bluedot/affected-packages)
          echo "turbo_filter=$TURBO_FILTER" >> $GITHUB_OUTPUT
          
      - name: Typecheck affected apps
        run: npx turbo typecheck ${{ steps.get_affected_apps.outputs.turbo_filter }}

      - name: Lint affected apps
        run: npx turbo lint ${{ steps.get_affected_apps.outputs.turbo_filter }}

      - name: Test affected apps
        run: |
          # Monitor CPU/process stats in background
          (while true; do
            cpu=$(top -bn1 | grep '%Cpu' | awk '{printf "%.0f%%", 100-$8}')
            node_procs=$(ps aux | grep -c '[n]ode' || true)
            vitest_procs=$(ps aux | grep -c '[v]itest' || true)
            echo "$(date +%H:%M:%S) cpu=$cpu node_procs=$node_procs vitest_procs=$vitest_procs"
            sleep 2
          done) &
          MONITOR_PID=$!
          npx turbo test ${{ steps.get_affected_apps.outputs.turbo_filter }}
          kill $MONITOR_PID 2>/dev/null || true

      - name: Get affected deployable apps
        id: get_affected_deployable_apps
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKFLOW_NAME: ${{ github.workflow }}
          GH_TOKEN: ${{ github.token }}
        run: |
          DEPLOY_ARRAY=$(npm run deploy_array --silent --workspace @bluedot/affected-packages)
          echo "deploy_array=$DEPLOY_ARRAY" >> $GITHUB_OUTPUT
    outputs:
      affected_deployable_apps: ${{ steps.get_affected_deployable_apps.outputs.deploy_array }}

  cd:
    needs: ci
    if: ${{ github.ref == 'refs/heads/master' && needs.ci.outputs.affected_deployable_apps != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.ci.outputs.affected_deployable_apps) }}
    concurrency:
      group: cd_${{ matrix.app }}
    timeout-minutes: 20
    steps:
      - name: Checkout ${{ github.sha }}
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Install NPM dependencies
        run: npm ci --audit false --fund false

      - name: Configure infra deployment
        if: matrix.app == '@bluedot/infra'
        run: |
          echo "$INFRA_PULUMI_PASSPHRASE" > apps/infra/passphrase.prod.txt
          mkdir -p ~/.aws
          echo "$INFRA_AWS_CREDENTIALS" > ~/.aws/credentials
        env:
          INFRA_PULUMI_PASSPHRASE: ${{ secrets.INFRA_PULUMI_PASSPHRASE }}
          INFRA_AWS_CREDENTIALS: ${{ secrets.INFRA_AWS_CREDENTIALS }}

      - name: Configure k8s deployment
        if: matrix.app != '@bluedot/infra'
        run: |
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          mkdir -p ~/.kube
          echo "$K8S_KUBECONFIG" > ~/.kube/config
        env:
          K8S_KUBECONFIG: ${{ secrets.K8S_KUBECONFIG }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set production secrets
        run: |
          sed -i 's/^AIRTABLE_PERSONAL_ACCESS_TOKEN=$/AIRTABLE_PERSONAL_ACCESS_TOKEN=${{ secrets.AIRTABLE_PERSONAL_ACCESS_TOKEN }}/' apps/website/.env.local

      - name: Deploy
        run: npm run deploy:cd --workspace ${{ matrix.app }}
