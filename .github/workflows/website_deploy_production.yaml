name: website_deploy_production

on:
  push:
    tags:
      - website/v*
  workflow_dispatch:
    inputs:
      skip_ci_check:
        description: 'Skip CI/CD check (force deploy)'
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Verify CI/CD has passed
        if: ${{ !inputs.skip_ci_check }}
        uses: actions/github-script@v7
        with:
          script: |
            const { data: { workflow_runs: [run] } } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner, repo: context.repo.repo,
              workflow_id: 'ci_cd.yaml', head_sha: context.sha,
            });
            if (!run || run.status !== 'completed' || run.conclusion !== 'success') {
              core.setFailed(`CI/CD has not passed for ${context.sha} (status: ${run?.status ?? 'not found'}, conclusion: ${run?.conclusion ?? 'N/A'})`);
            }

      - name: Install turbo
        id: install_turbo
        run: |
          npm install --global turbo

      - name: Checkout ${{ github.sha }}
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Install NPM dependencies
        run: npm ci

      - name: Configure k8s deployment
        run: |
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          mkdir -p ~/.kube
          echo "$K8S_KUBECONFIG" > ~/.kube/config
        env:
          K8S_KUBECONFIG: ${{ secrets.K8S_KUBECONFIG }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set production secrets
        run: |
          sed -i 's/^AIRTABLE_PERSONAL_ACCESS_TOKEN=$/AIRTABLE_PERSONAL_ACCESS_TOKEN=${{ secrets.AIRTABLE_PERSONAL_ACCESS_TOKEN }}/' apps/website/.env.local

      - name: Deploy production
        run: npm run deploy:multistage:production --workspace apps/website
